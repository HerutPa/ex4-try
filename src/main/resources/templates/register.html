<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register</title>
    <style>
        label { display:block; margin-top:8px; }
        .error { color:#c00; margin:6px 0; }
        .hint  { color:#666; font-size:.9em; }
    </style>
</head>
<body>
<h1>Create account</h1>

<!-- הודעת שגיאה כללית (אם יש) -->
<div th:if="${error}" th:text="${error}" class="error"></div>

<form th:action="@{/register}" th:object="${form}" method="post">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

    <label>Email:
        <input type="email" th:field="*{email}" required />
    </label>
    <div class="error" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>

    <label>Full name:
        <input type="text" th:field="*{fullName}" required />
    </label>
    <div class="error" th:if="${#fields.hasErrors('fullName')}" th:errors="*{fullName}"></div>

    <label>Role:
        <select th:field="*{role}" id="roleSelect" required>
            <!-- אין אופציה ריקה כי יש ברירת מחדל Role.USER -->
            <option th:each="r : ${T(com.example.demo.model.Role).values()}"
                    th:value="${r}" th:text="${r}">ROLE</option>
        </select>
    </label>

    <!-- Skills: מוצג רק כשנבחר USER; בנוסף, JS ידאג דינמית בזמן שינוי -->
    <div id="skillsBox"
         th:style="${form.role} == 'USER' ? 'display:block' : 'display:none'">
        <label>Skills (choose):</label>
        <div>
            <div th:each="skill : ${allSkills}" style="display:inline-block; margin:3px 10px 3px 0;">
                <label style="display:inline-flex; align-items:center; gap:4px;">
                    <input type="checkbox" th:value="${skill.name}" th:field="*{skills}"/>
                    <span th:text="${skill.name}"></span>
                </label>
            </div>
        </div>

        <label>Or add free text (comma/semicolon):
            <input type="text" th:field="*{freeTextSkills}" placeholder="e.g. Java; React; SQL" />
        </label>
        <div class="hint">Example: Java; React; SQL</div>
        <div class="error" th:if="${#fields.hasErrors('skills')}" th:errors="*{skills}"></div>
        <div class="error" th:if="${#fields.hasErrors('freeTextSkills')}" th:errors="*{freeTextSkills}"></div>
    </div>

    <label>Password:
        <input type="password" th:field="*{password}" required />
    </label>
    <div class="error" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></div>

    <label>Confirm password:
        <input type="password" th:field="*{confirmPassword}" required />
    </label>
    <div class="error" th:if="${#fields.hasErrors('confirmPassword')}" th:errors="*{confirmPassword}"></div>

    <button type="submit" style="margin-top:12px;">Register</button>
</form>

<p style="margin-top:10px;">
    Already have an account? <a th:href="@{/login}">Login</a>
</p>

<!-- סקריפט: מציג/מסתיר וגם מנקה/מנטרל את שדות ה-Skills כשהם מוסתרים -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
      const roleSelect = document.getElementById("roleSelect");
      const skillsBox  = document.getElementById("skillsBox");

      // קבוצה של כל צ׳קבוקסים + טקסט חופשי בתוך skillsBox
      const getSkillCheckboxes = () => skillsBox.querySelectorAll('input[type="checkbox"]');
      const getFreeTextInput   = () => skillsBox.querySelector('input[type="text"]');

      function setSkillsEnabled(enabled) {
        getSkillCheckboxes().forEach(cb => { cb.disabled = !enabled; if (!enabled) cb.checked = false; });
        const ft = getFreeTextInput();
        if (ft) { ft.disabled = !enabled; if (!enabled) ft.value = ""; }
      }

      function toggleSkills() {
        const isUser = roleSelect.value === "USER";
        skillsBox.style.display = isUser ? "block" : "none";
        setSkillsEnabled(isUser);
      }

      roleSelect.addEventListener("change", toggleSkills);
      toggleSkills(); // הפעלה ראשונית
    });
</script>
</body>
</html>
