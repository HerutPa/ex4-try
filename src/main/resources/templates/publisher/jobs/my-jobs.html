<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      lang="en" dir="ltr"
      th:replace="fragments/layout :: content(~{::section}, 'My Jobs')">

<section>
  <style>
    .page-head{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.18);
      border-radius:18px;
      padding:22px 24px;
      backdrop-filter:blur(10px);
      margin-bottom:18px;
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
    }
    .page-title{
      margin:0; font-size:2rem; font-weight:900;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
    }
    .subtitle{ color:rgba(255,255,255,.85); font-size:1rem; }

    .panel{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      padding:22px;
      backdrop-filter:blur(10px);
      margin-bottom:16px;
    }

    .alert{
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18);
      border-left:4px solid #667eea; color:#fff; border-radius:12px; padding:12px 14px; margin:12px 0;
    }
    .alert-error{ border-left-color:#e74c3c }

    /* ×˜×‘×œ×” */
    .table{ width:100%; border-collapse:collapse; }
    .table th, .table td{ padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.12); color:#fff }
    .table th{ background:rgba(255,255,255,.06); position:sticky; top:0 }
    .nowrap{ white-space:nowrap }

    .status-yes{ color:#a4ffcb; font-weight:700 }
    .status-no{ color:#ff8c8c; font-weight:700 }
    .muted{ color:rgba(255,255,255,.8) }

    /* ×›×¤×ª×•×¨×™× ×‘×¢×™×¦×•×‘ ××—×™×“ */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 18px; border-radius:12px; font-weight:800; text-decoration:none;
      cursor:pointer; transition:.25s; border:none;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff; box-shadow:0 6px 18px rgba(102,126,234,.35);
    }
    .btn:hover{ transform:translateY(-2px); box-shadow:0 10px 26px rgba(102,126,234,.5); }

    .btn.secondary{
      background:rgba(255,255,255,.1);
      border:1px solid rgba(255,255,255,.18);
      box-shadow:none;
    }
    .btn.danger{
      background:linear-gradient(135deg,#e74c3c 0%,#c0392b 100%);
      box-shadow:0 6px 18px rgba(231,76,60,.35);
    }
    .btn.danger:hover{
      box-shadow:0 10px 26px rgba(231,76,60,.5);
    }
    .btn.small{ padding:6px 12px; font-size:.9rem; font-weight:700 }

    .pagination{ text-align:center; padding-top:12px; border-top:1px solid rgba(255,255,255,.12); margin-top:14px }
    .pagination .btn{ margin:0 4px }

    /* âœ… Modal ××¢×•×¦×‘ ×™×¤×” */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.75);
      backdrop-filter:blur(8px);
      display:none; align-items:center; justify-content:center; z-index:9999;
      animation:fadeIn .2s ease;
    }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    .modal-box{
      background:linear-gradient(135deg, #434343 0%, #000000 100%);
      padding:32px 36px; border-radius:20px; min-width:380px; max-width:500px;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
      border:1px solid rgba(255,255,255,.1);
      animation:slideUp .3s ease;
    }
    @keyframes slideUp{ from{transform:translateY(30px); opacity:0} to{transform:translateY(0); opacity:1} }

    .modal-icon{
      font-size:64px; margin-bottom:16px;
      filter:drop-shadow(0 4px 12px rgba(231,76,60,.4));
    }
    .modal-title{
      font-size:1.8rem; font-weight:900; margin:0 0 12px; color:#fff;
    }
    .modal-text{
      color:rgba(255,255,255,.85); font-size:1.05rem; line-height:1.5; margin-bottom:24px;
    }
    .modal-buttons{
      display:flex; gap:12px; justify-content:center;
    }
    .modal-buttons button{
      flex:1; max-width:150px;
    }
  </style>

  <div class="container">
    <div class="page-head">
      <div>
        <h1 class="page-title">My Jobs</h1>
        <p class="subtitle">Manage your published jobs</p>
      </div>
      <a th:href="@{/publisher/home}" class="btn secondary">
        <i class="fa-solid fa-arrow-left"></i> Homepage
      </a>
    </div>

    <div th:if="${msg}" class="alert" th:text="${msg}"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <h3 style="color:#fff; margin:0; font-weight:900;">Create New Job</h3>
        <button type="button" class="btn" onclick="toggleNewJobForm()">
          <i class="fa-solid fa-plus"></i> New Job
        </button>
      </div>

      <div id="newJobBox" style="display:none; margin-top:12px;">
        <form th:action="@{/publisher/jobs}" th:object="${form}" method="post">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
          <div th:if="${#fields.hasAnyErrors()}" class="alert alert-error">
            <ul style="margin:0; padding-inline-start:18px">
              <li th:each="e : ${#fields.allErrors()}" th:text="${e}">err</li>
            </ul>
          </div>

          <div class="panel" style="margin-top:8px;" th:replace="~{publisher/jobs/jobs_form :: jobForm}"></div>

          <button type="submit" class="btn">âœ… Create Job</button>
        </form>
      </div>
    </div>

    <div th:if="${!#lists.isEmpty(page.content)}" class="panel">
      <p class="muted" style="margin:0 0 10px; font-weight:800;">
        Total: <strong style="color:#ffef9c;" th:text="${page.totalElements}">0</strong> Jobs
      </p>

      <table class="table">
        <thead>
        <tr>
          <th>Title</th><th>Company</th><th>Category</th><th>Location</th>
          <th>Status</th><th>Reviews</th><th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="j : ${page.content}">
          <td th:text="${j.title}">title</td>
          <td th:text="${j.company}">company</td>
          <td th:text="${j.category != null ? j.category.name : '-'}">-</td>
          <td th:text="${j.location ?: '-'}">-</td>
          <td>
            <span th:text="${j.active} ? 'Active' : 'Inactive'"
                  th:class="${j.active ? 'status-yes' : 'status-no'}">Status</span>
          </td>
          <td class="nowrap">
            <a th:href="@{'/publisher/jobs/' + ${j.id} + '/reviews'}" class="btn small">
              <i class="fa-solid fa-star"></i> Reviews
            </a>
            <span class="hint" th:text="'(' + ${#lists.size(j.reviews)} + ')'">(#)</span>
          </td>
          <td class="nowrap">
            <a th:href="@{/publisher/jobs/{id}/edit(id=${j.id})}" class="btn small">
              <i class="fa-solid fa-pen"></i> Edit
            </a>

            <form th:action="@{/publisher/jobs/{id}/toggle(id=${j.id})}" method="post" style="display:inline">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
              <button type="submit" class="btn small"
                      th:text="${j.active} ? 'â¸ Pause' : 'â–¶ Activate'"></button>
            </form>

            <button type="button" class="btn small danger"
                    th:attr="data-job-id=${j.id},data-job-title=${j.title}"
                    onclick="openDeleteModal(this)">
              <i class="fa-solid fa-trash"></i> Delete
            </button>
          </td>
        </tr>
        </tbody>
      </table>

      <div class="pagination" th:if="${page.totalPages > 1}">
        <span class="muted" th:text="'Page ' + (${page.number}+1) + ' of ' + ${page.totalPages}"></span>
        <div style="margin-top:10px">
          <a class="btn small secondary"
             th:if="${page.hasPrevious()}"
             th:href="@{|/publisher/jobs?page=${(page.number - 1)}&size=${page.size}|}">
            â† Previous
          </a>
          <a class="btn small secondary"
             th:if="${page.hasNext()}"
             th:href="@{|/publisher/jobs?page=${(page.number + 1)}&size=${page.size}|}">
            Next â†’
          </a>
        </div>
      </div>
    </div>

    <div th:if="${#lists.isEmpty(page.content)}" class="panel" style="text-align:center">
      <div style="font-size:64px; margin-bottom:10px">ğŸ“­</div>
      <h2 style="margin:0 0 6px; color:#fff">You don't have any jobs yet</h2>
      <p class="muted">Click "New Job" to get started</p>
    </div>
  </div>

  <!-- âœ… Modal ××¢×•×¦×‘ ××—×“×© -->
  <div id="deleteModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-icon">ğŸ—‘ï¸</div>
      <h3 class="modal-title">Delete Job</h3>
      <p class="modal-text">
        Are you sure you want to delete <strong id="jobTitleDisplay">this job</strong>?<br>
        <span style="color:rgba(255,255,255,.6); font-size:.95rem;">This action cannot be undone.</span>
      </p>
      <div class="modal-buttons">
        <form id="deleteFormTemplate" method="post">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
          <button type="submit" class="btn danger">
            <i class="fa-solid fa-trash"></i> Delete
          </button>
        </form>
        <button type="button" class="btn secondary" onclick="closeDeleteModal()">
          <i class="fa-solid fa-xmark"></i> Cancel
        </button>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    function toggleNewJobForm(){
      const box = document.getElementById('newJobBox');
      box.style.display = (box.style.display === 'none' || box.style.display === '') ? 'block' : 'none';
    }

    function openDeleteModal(button){
      const jobId = button.getAttribute("data-job-id");
      const jobTitle = button.getAttribute("data-job-title") || "this job";

      const modal = document.getElementById("deleteModal");
      const form = document.getElementById("deleteFormTemplate");
      const titleDisplay = document.getElementById("jobTitleDisplay");

      form.setAttribute("action", `/publisher/jobs/${jobId}/delete`);
      titleDisplay.textContent = `"${jobTitle}"`;
      modal.style.display = "flex";
    }

    function closeDeleteModal(){
      document.getElementById("deleteModal").style.display = "none";
    }

    // âœ… ×¡×’×™×¨×” ×‘×œ×—×™×¦×” ××—×•×¥ ×œmodal
    document.getElementById("deleteModal").addEventListener("click", function(e){
      if(e.target === this) closeDeleteModal();
    });

    // âœ… ×¡×’×™×¨×” ×‘-ESC
    document.addEventListener("keydown", function(e){
      if(e.key === "Escape") closeDeleteModal();
    });
  </script>
</section>
</html>