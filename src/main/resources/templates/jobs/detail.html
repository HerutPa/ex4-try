<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="${job.title}">Job</title>
    <style>
        body{font-family:Arial, sans-serif; margin:24px; max-width:900px}
        .meta{display:grid; grid-template-columns:160px 1fr; gap:8px 16px; margin:16px 0}
        .btn{display:inline-block; padding:8px 12px; border:1px solid #333; text-decoration:none}
        pre { white-space: pre-wrap; font-family: inherit; }
        .muted{color:#777}
        .review{border-bottom:1px solid #eee; padding:10px 0}
        .stars{font-size:18px; letter-spacing:2px}
    </style>
</head>
<body>
<p><a href="/jobs">← Back to Jobs</a></p>

<h1 th:text="${job.title}">Title</h1>

<div class="meta">
    <div><b>Company:</b></div>
    <div th:text="${job.company != null and !#strings.isEmpty(job.company) ? job.company : '-'}">-</div>

    <div><b>Category:</b></div>
    <div th:text="${job.category != null ? job.category.name : '-'}">-</div>

    <div><b>Location:</b></div>
    <div th:text="${job.location != null and !#strings.isEmpty(job.location) ? job.location : '-'}">-</div>

    <div><b>Salary:</b></div>
    <div th:text="${(job.salaryMin != null ? job.salaryMin : '-') + ' - ' + (job.salaryMax != null ? job.salaryMax : '-') }">-</div>

    <div><b>Created at:</b></div>
    <div th:text="${#temporals.format(job.createdAt, 'yyyy-MM-dd HH:mm')}">date</div>

    <div><b>Status:</b></div>
    <div th:text="${job.active} ? 'Active' : 'Inactive'">Active</div>
</div>

<h3>Description</h3>
<pre th:text="${job.description}">Description…</pre>

<p style="margin-top: 16px">
    <a class="btn" th:href="${job.externalUrl}" target="_blank" rel="noopener noreferrer">
        Apply on company site
    </a>
</p>

<hr>

<!-- ===== Reviews Section ===== -->
<section>
    <h2>Reviews</h2>

    <!-- Summary -->
    <div th:if="${reviewsCount != null and reviewsCount > 0}">
        <div style="margin-bottom:6px">
            Average rating:
            <strong th:text="${#numbers.formatDecimal(avgRating,1,1)}">0.0</strong>
            <span class="muted" th:text="'(' + ${reviewsCount} + ' reviews)'">(0 reviews)</span>
        </div>
        <!-- Visual stars (rounded) -->
        <div class="stars" th:with="full=${T(java.lang.Math).round(avgRating)}">
            <span th:each="i : ${#numbers.sequence(1,5)}"
                  th:text="${i <= full} ? '★' : '☆'">★</span>
        </div>
    </div>

    <hr>
    <h3>Leave a review</h3>
    <div th:if="${msg}" style="color:green" th:text="${msg}"></div>

    <form th:action="@{|/jobs/${job.id}/reviews|}" method="post" th:object="${reviewForm}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

        <label>Rating</label>
        <select th:field="*{rating}">
            <option value="">--</option>
            <option th:each="i : ${#numbers.sequence(1,5)}" th:value="${i}" th:text="${i}">1</option>
        </select>
        <div th:if="${#fields.hasErrors('rating')}" th:errors="*{rating}" style="color:red"></div>

        <label>Name</label>
        <input th:field="*{reviewerName}">
        <div th:if="${#fields.hasErrors('reviewerName')}" th:errors="*{reviewerName}" style="color:red"></div>

        <label>Comment</label>
        <textarea rows="4" th:field="*{comment}"></textarea>
        <div th:if="${#fields.hasErrors('comment')}" th:errors="*{comment}" style="color:red"></div>

        <button type="submit" class="btn">Submit</button>
    </form>


    <!-- No reviews -->
    <div th:if="${reviewsCount == null or reviewsCount == 0}" class="muted">
        No reviews yet.
    </div>

    <!-- List -->
    <div th:each="r : ${reviews}" class="review">
        <div>
            <span class="stars" th:each="i : ${#numbers.sequence(1,5)}"
                  th:text="${i <= r.rating} ? '★' : '☆'">★</span>
            <strong th:text="${r.reviewerName}">Reviewer</strong>
            <span class="muted" th:text="${#temporals.format(r.createdAt, 'yyyy-MM-dd HH:mm')}">date</span>
        </div>
        <div th:if="${r.comment}" th:text="${r.comment}">comment</div>
    </div>
</section>

</body>
</html>
