<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
      lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="${job.title}">Job</title>
    <style>
        body{font-family:Arial, sans-serif; margin:24px; max-width:900px}
        .meta{display:grid; grid-template-columns:160px 1fr; gap:8px 16px; margin:16px 0}
        .btn{display:inline-block; padding:8px 12px; border:1px solid #333; text-decoration:none; cursor:pointer; background:white}
        .btn:hover{background:#f0f0f0}
        pre { white-space: pre-wrap; font-family: inherit; }
        .muted{color:#777}
        .review{border-bottom:1px solid #eee; padding:10px 0}
        .stars{font-size:18px; letter-spacing:2px}

        /* 🆕 Favorite button styles */
        .favorite-btn {
            background: none;
            border: 2px solid #ffd700;
            padding: 10px 20px;
            font-size: 24px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        .favorite-btn:hover {
            transform: scale(1.1);
        }
        .favorite-btn.active {
            background: #ffd700;
        }
        .action-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 16px;
        }
    </style>
</head>
<body>
<p><a href="/jobs">← Back to Jobs</a></p>

<h1 th:text="${job.title}">Title</h1>

<div class="meta">
    <div><b>Company:</b></div>
    <div th:text="${job.company != null and !#strings.isEmpty(job.company) ? job.company : '-'}">-</div>

    <div><b>Category:</b></div>
    <div th:text="${job.category != null ? job.category.name : '-'}">-</div>

    <div><b>Location:</b></div>
    <div th:text="${job.location != null and !#strings.isEmpty(job.location) ? job.location : '-'}">-</div>

    <!-- ✅ Skills -->
    <div><b>Skills:</b></div>
    <div>
        <div th:if="${job.skills != null and !job.skills.isEmpty()}">
            <span th:each="s : ${job.skills}"
                  class="skill-badge"
                  th:text="${s.name}">Skill</span>
        </div>
        <div class="muted" th:unless="${job.skills != null and !job.skills.isEmpty()}">-</div>
    </div>

    <div><b>Created at:</b></div>
    <div th:text="${#temporals.format(job.createdAt, 'yyyy-MM-dd HH:mm')}">date</div>

    <div><b>Status:</b></div>
    <div th:text="${job.active} ? 'Active' : 'Inactive'">Active</div>
</div>

<h3>Description</h3>
<pre th:text="${job.description}">Description…</pre>

<div class="action-buttons">
    <a class="btn" th:href="${job.externalUrl}" target="_blank" rel="noopener noreferrer">
        Apply on company site
    </a>

    <!-- 🆕 Favorite button - רק למשתמשים מחוברים עם תפקיד USER -->
    <button sec:authorize="hasRole('USER')"
            class="favorite-btn"
            id="favoriteBtn"
            th:data-job-id="${job.id}"
            onclick="toggleFavorite()">
        ☆
    </button>
</div>

<hr>

<!-- ===== Reviews Section ===== -->
<section>
    <h2>Reviews</h2>

    <!-- Summary -->
    <div th:if="${reviewsCount != null and reviewsCount > 0}">
        <div style="margin-bottom:6px">
            Average rating:
            <strong th:text="${#numbers.formatDecimal(avgRating,1,1)}">0.0</strong>
            <span class="muted" th:text="'(' + ${reviewsCount} + ' reviews)'">(0 reviews)</span>
        </div>
        <!-- Visual stars (rounded) -->
        <div class="stars" th:with="full=${T(java.lang.Math).round(avgRating)}">
            <span th:each="i : ${#numbers.sequence(1,5)}"
                  th:text="${i <= full} ? '★' : '☆'">★</span>
        </div>
    </div>

    <hr>
    <h3>Leave a review</h3>
    <div th:if="${msg}" style="color:green" th:text="${msg}"></div>

    <form th:action="@{|/jobs/${job.id}/reviews|}" method="post" th:object="${reviewForm}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

        <label>Rating</label>
        <select th:field="*{rating}">
            <option value="">--</option>
            <option th:each="i : ${#numbers.sequence(1,5)}" th:value="${i}" th:text="${i}">1</option>
        </select>
        <div th:if="${#fields.hasErrors('rating')}" th:errors="*{rating}" style="color:red"></div>

        <label>Name</label>
        <input th:field="*{reviewerName}">
        <div th:if="${#fields.hasErrors('reviewerName')}" th:errors="*{reviewerName}" style="color:red"></div>

        <label>Comment</label>
        <textarea rows="4" th:field="*{comment}"></textarea>
        <div th:if="${#fields.hasErrors('comment')}" th:errors="*{comment}" style="color:red"></div>

        <button type="submit" class="btn">Submit</button>
    </form>


    <!-- No reviews -->
    <div th:if="${reviewsCount == null or reviewsCount == 0}" class="muted">
        No reviews yet.
    </div>

    <!-- List -->
    <div th:each="r : ${reviews}" class="review">
        <div>
            <span class="stars" th:each="i : ${#numbers.sequence(1,5)}"
                  th:text="${i <= r.rating} ? '★' : '☆'">★</span>
            <strong th:text="${r.reviewerName}">Reviewer</strong>
            <span class="muted" th:text="${#temporals.format(r.createdAt, 'yyyy-MM-dd HH:mm')}">date</span>
        </div>
        <div th:if="${r.comment}" th:text="${r.comment}">comment</div>
    </div>
</section>

<!-- 🆕 JavaScript לניהול מועדפים -->
<script th:inline="javascript">
    const jobId = /*[[${job.id}]]*/ null;
    const favoriteBtn = document.getElementById('favoriteBtn');
    const csrfToken = /*[[${_csrf.token}]]*/ '';
    const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

    // טעינת סטטוס התחלתי
    if (favoriteBtn) {
        checkFavoriteStatus();
    }

    function checkFavoriteStatus() {
        fetch(`/jobs/${jobId}/favorite-status`)
            .then(res => res.json())
            .then(data => {
                updateButton(data.favorite);
            })
            .catch(err => console.error('Error checking favorite status:', err));
    }

    function toggleFavorite() {
        fetch(`/jobs/${jobId}/favorite`, {
            method: 'POST',
            headers: {
                [csrfHeader]: csrfToken
            }
        })
            .then(res => res.json())
            .then(data => {
                updateButton(data.favorite);
            })
            .catch(err => console.error('Error toggling favorite:', err));
    }

    function updateButton(isFavorite) {
        if (isFavorite) {
            favoriteBtn.textContent = '★'; // כוכב מלא
            favoriteBtn.classList.add('active');
        } else {
            favoriteBtn.textContent = '☆'; // כוכב ריק
            favoriteBtn.classList.remove('active');
        }
    }
</script>

</body>
</html>